---
layout: post
title: "C++研发环境"
description: C++研发环境
modified: 2022-01-01
category: C++
tags: [C++]
---

# 一、要点

1.使用动态链接库，windows下dll，mac下dylib，Linux下so文件。 

Windows下注意toolchain的配置，一般可以配置MinGW，有些DLL的使用例如CTP的库，需要配置Visual Studio工具链。CMakeLists.txt：

    cmake_minimum_required(VERSION 3.20)
    project(exeproj)
    
    set(CMAKE_CXX_STANDARD 14)
    
    #设置头文件路径
    set(INC_DIR ./include)
    
    #设置链接库路径
    set(LINK_DIR ./lib)
    
    #引入头文件
    include_directories(${INC_DIR})
    
    #引入库文件
    link_directories(${LINK_DIR})
    
    add_executable(exeproj main.cpp)
    
    # windows 将第三方库连接在一起
    #target_link_libraries(exeproj liblibproj.dll)
    # mac
    #target_link_libraries(exeproj liblibproj.dylib)
    # linux
    target_link_libraries(exeproj liblibproj.so)

2.配置Remote Host，Mac和Windows上跨端的编译环境。

制作Docker Ubuntu镜像，Ubuntu容器作为Remote Host。

    制作镜像时，Windows下注意文件换行格式修改为LF，否则可能出现问题。
    
    # 制作新镜像
    docker build -f Dockerfile -t mydev/ubuntu:1.0.0 .
    
    # 创建容器
    docker run -d --cap-add sys_ptrace -p 127.0.0.1:45678:22 -p 127.0.0.1:8730:873 --name mycpp mydev/ubuntu:1.0.0
    
    # 进入容器
    docker exec -it mycpp bash
    
    # 解决执行中文乱码问题
    *.h和*.cpp文件，全部都使用UTF-8编码。
    apt-get upgrade
    dpkg-reconfigure locales
    echo "export LANG=zh_CN.utf8" >> /etc/bash.bashrc
    echo "export LANGUAGE=zh_CN.utf8" >> /etc/bash.bashrc

Dockerfile：

    FROM hub.c.163.com/library/ubuntu:16.04
    
    RUN apt-get update
    
    RUN apt-get install -y build-essential
    RUN apt-get install -y gdb
    
    RUN apt-get install -y openssh-server
    RUN mkdir /var/run/sshd
    RUN sed -ri 's/^PermitRootLogin\s+.*/PermitRootLogin yes/' /etc/ssh/sshd_config
    RUN sed -ri 's/UsePAM yes/#UsePAM yes/g' /etc/ssh/sshd_config
    
    RUN apt-get install -y rsync
    RUN sed -ri 's/RSYNC_ENABLE=false/RSYNC_ENABLE=true/g' /etc/default/rsync
    COPY rsync.conf /etc
    
    RUN echo 'root:000000' |chpasswd
    
    RUN mkdir /root/sync
    
    COPY entrypoint.sh /sbin
    RUN chmod +x /sbin/entrypoint.sh
    ENTRYPOINT [ "/sbin/entrypoint.sh" ]
    
    RUN wget "https://cmake.org/files/v3.20/cmake-3.20.5-linux-x86_64.tar.gz" \
    && tar zxvf cmake-3.20.5-linux-x86_64.tar.gz \
    && mv cmake-3.20.5-linux-x86_64 /opt/cmake-3.20.5 \
    && ln -sf /opt/cmake-3.20.5/bin/*  /usr/bin/

entrypoint.sh：

    #!/bin/bash
    
    /usr/bin/rsync --daemon --config=/etc/rsync.conf
    /usr/sbin/sshd -D

rsync.conf：

    # 编辑配置信息
    max connections = 8
    log file = /var/log/rsync.log
    timeout = 300
    
    [sync] # 模块名
    comment = sync
    # path为需要同步的文件夹路径
    path = /root/sync
    read only = no
    list = yes
    uid = root
    gid = root

3.解决Linux环境下找不到so包的问题

    cmake_minimum_required(VERSION 3.20)
    project(demo2)
    set(CMAKE_CXX_STANDARD 14)
    set(CMAKE_BUILD_TYPE Debug)
    
    #设置头文件路径
    set(INC_DIR ./include)
    #设置链接库路径
    set(LINK_DIR ./lib)
    #引入头文件
    include_directories(${INC_DIR})
    #引入库文件
    link_directories(${LINK_DIR})
    
    # Linux
    add_library(thostmduserapi_se SHARED IMPORTED)
    add_library(thosttraderapi_se SHARED IMPORTED)
    SET_PROPERTY(TARGET thostmduserapi_se PROPERTY IMPORTED_LOCATION ${PROJECT_SOURCE_DIR}/lib/thostmduserapi_se.so)
    SET_PROPERTY(TARGET thosttraderapi_se PROPERTY IMPORTED_LOCATION ${PROJECT_SOURCE_DIR}/lib/thosttraderapi_se.so)
    
    FILE(GLOB_RECURSE CURRENT_SOURCES src/*.cpp)
    
    add_executable(demo2 main.cpp ${CURRENT_SOURCES})
    
    # windows将第三方库连接在一起
    #target_link_libraries(demo2 thostmduserapi_se.lib thosttraderapi_se.lib)
    # Linux
    target_link_libraries(demo2 thostmduserapi_se thosttraderapi_se)

# 二、参考

1.[Clion使用踩坑（调用外部DLL配置）](https://blog.csdn.net/qq_18453581/article/details/120005712)

2.[使用Clion生成并测试动态链接库 DLL](https://blog.csdn.net/hezhongla0811/article/details/109769789)

3.[利用Docker和CLion在Mac优雅地开发和调试Linux C++程序](https://www.jianshu.com/p/8648475b26b3)
